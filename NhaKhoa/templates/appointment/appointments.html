{% extends "layouts/base.html" %}

{% block content %}
<h2>Danh sách lịch hẹn</h2>
<a class="btn btn-success mb-3" href="{{ url_for('add_appointment') }}">+ Thêm lịch hẹn</a>

<!-- Form tìm kiếm -->
<form method="GET" action="{{ url_for('appointments') }}" class="mb-3 row g-2">
    <div class="col-auto">
        <select name="filter_by" class="form-select" id="filter_by" onchange="toggleKeywordInput()">
            <option value="patient" {% if request.args.get(
            'filter_by') == 'patient' %}selected{% endif %}>Bệnh nhân</option>
            <option value="doctor" {% if request.args.get(
            'filter_by') == 'doctor' %}selected{% endif %}>Bác sĩ</option>
            <option value="date" {% if request.args.get(
            'filter_by') == 'date' %}selected{% endif %}>Thời gian</option>
        </select>
    </div>
    <div class="col-auto">
        <input type="text" name="keyword" id="keyword_input" class="form-control" placeholder="Nhập từ khóa"
               value="{{ request.args.get('keyword','') }}">
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        <a href="{{ url_for('appointments') }}" class="btn btn-secondary">Xóa</a>
    </div>
</form>


<table class="table table-striped table-bordered">
    <thead class="table-dark">
    <tr>
        <th>ID</th>
        <th>Bệnh nhân</th>
        <th>Bác sĩ</th>
        <th>Thời gian</th>
        <th>Mô tả</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    {% for a in appointments %}
    <tr>
        <td>{{ a.id }}</td>
        <td>{{ a.patient.name if a.patient else '' }}</td>
        <td>{{ a.schedule.doctor.name if a.schedule and a.schedule.doctor else '' }}</td>
        <td>
            {%- if a.schedule %}
                {{ a.schedule.from_date.strftime('%H:%M') }} -
                {{ a.schedule.to_date.strftime('%H:%M %d-%m-%Y') }}
            {%- else %}
                {{ '' }}
            {%- endif %}
        </td>
        <td>{{ a.description }}</td>
        <td>
            <a class="btn btn-primary btn-sm" href="{{ url_for('edit_appointment', id=a.id) }}">Sửa</a>
            <a class="btn btn-danger btn-sm" href="{{ url_for('delete_appointment', id=a.id) }}"
               onclick="return confirm('Xóa lịch hẹn?')">Xóa</a>
        </td>
    </tr>
    {% endfor %}
</tbody>

</table>

<script>
    function toggleKeywordInput() {
        const filter = document.getElementById('filter_by').value;
        const input = document.getElementById('keyword_input');
        if(filter === 'date') {
            input.type = 'date';  // calendar picker
        } else {
            input.type = 'text';
        }
    }

    // Khởi tạo khi load trang
    window.onload = toggleKeywordInput;
</script>
{% endblock %}
